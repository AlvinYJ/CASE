## 事件报告



### 概括

SHECA 收到的邮件提醒，告知我们有一张EV证书的RDN项顺序存在问题，我们立刻排查下所有的EV证书，发现一共有三张证书都存在这个问题。

### 影响

据BR 2.0.0 7.1.4.2章节的规定，当CA证书主体字段中包含表中列出的属性时，必须按照表中的相对顺序对这些属性进行编码，并遵循属性的指定编码要求。此规定自2023年9月15日起生效。

然而，2023年9月15日之后，SHECA共签发了13张EV SSL证书，其中8张存在错误。错误的证书中，有3张签发给客户且已吊销，其余5张为SHECA内部使用，且均已吊销，因此未产生较大影响。

### 时间线

所有时间戳均为北京时间 (UTC+8)

- **2024-06-14 03:24**  我们收到Ryan Daurne 的邮件，提示此证书https://crt.sh/?id=10981773243 的DN项顺序有存在异常
- **2024-06-14 09:00** 调查开始
- **2024-06-14 09:05**  确认此张证书的DN项中的顺序存在异常不符合BR的要求。
- **2024-06-14 09:10**  发现到我们的lint应该存在问题，因为我们使用zlint去检查预证书，但是它并未提示报错，我们检查了zlint在2024年三月份的时候增加了这个lingting。
- **2024-06-04 10:00** 编写脚本使用最新版本的zlint 检查所有2023-09-15 签发的EV证书，发现存在8张证书存在相同的问题
- **2024-06-14 10:21** 发现有三张存在问题的证书未吊销，立刻吊销这三张证书。（发生事故后24小时内吊销）
- **2024-06-14 10:30** 开始排查问题产生的原因
- **2024-06-14 12:30** 开启Bugzilla 漏洞向ccabd初步说明情况
- **2024-06-14 21:30** 问题产生的原因是在测试环境中新旧CA系统并行运行，流量入口灰度比例分别为旧CA系统：40%，新CA系统：60%。在进行DN顺序项改造的过程中，旧的CA系统未按照BR的要求进行更改，而新的CA系统中更改是有效的，测试工程师中测试脚本仅执行了一次，本次请求被转发中到了新的CA系统中，导致测试工程师未能发现旧的CA系统存在问题。
- **2024-06-14 22:30 ** 立即修复旧CA系统的BUG，并进行了版本发布
- **2024-06-14 23:00** 开始起草事件报告
- **2024-06-15 10:00** 相关负责人检查报告的说明是否准确清晰
- **2024-06-15 17:00** 发布完整的事件报告



### 根本原因分析

背景介绍：由于我们的旧的CA系统已经运营了13年，目前无法满足业务需求，因此我们在2022年12月启动了新的CA系统开发工作。新的CA系统在2023年7月完成开发并开始试运营。我们对两套CA系统并行运行然后按照百分比进行流量分配，以确保新的CA系统平稳替代旧的CA系统。

- **为什么证书的DN项顺序存在问题？**

   这些证书的请求流量被分配到了旧的CA系统中，而旧的CA系统未对EV证书的DN项顺序进行正确调整。

- **为什么在旧的CA系统中签发证书？** 

  在两套CA系统切换过程中，我们并行运行两套系统并按百分比分配流量，以保证新系统平稳替代旧系统。因此，有一部分流量（旧CA系统：40%，新CA系统：60%）仍进入旧的CA系统。

- **为什么测试人员没有发现旧系统改造存在问题？** 

  测试人员在测试环境中进行测试时，测试用例脚本仅运行了一次且流量被分配到了新的CA系统，导致未能发现旧CA系统改造存在问题。

- **为什么你们的lint未检测出这个问题？** 

  我们使用zlint作为检测工具，并定期更新版本。然而，对证书DN项检查的linting功能是在2024年3月发布的，这些错误证书都是在2024年3月之前签发的，因此zlint未能检测出这个问题。

- **为什么没有及早发现这个问题？** 

  这个问题存在一定的隐蔽性。我们的合规人员每天在crt.sh上对当天的证书进行简单抽样检测，但通过crt.sh的linting也未发现问题。目前crt.sh的linting工具版本尚未升级，因此未能检测出该问题。

### 得到教训

#### 进展顺利

- 收到告警后，SHECA迅速做出响应。

- 合规部门在2023年6月就向我们提出了DN项顺序的整改需求，我们在2023年8月完成了相关整改。因此，当收到邮件告警后，我们立即意识到这是一个程序错误，迅速查询相关开发文档，并很快定位到问题原因。

  

#### 哪些地方不太顺利

- 在新旧CA系统的迭代过程中，我们常常忽视了对旧CA系统兼容性的充分考虑。
- 由于新旧系统的更新迭代，我们已经遇到过类似的问题。本次问题的产生也是由于新旧系统的切换。因此，我们需要反思这个问题，分析问题出现的原因及易发点，并记录下来。在之后的升级迭代中，应充分考虑这些易发问题。
- 我们意识到zlint对BR规则更新的支持存在延迟，这导致我们未能及时发现问题。我们应在zlint的基础上增加SHECA自己的lint，以支持zlint尚未支持的liting。
- 针对两套CA系统并行运行的情况，测试部门的测试用例脚本不应仅在运行一次即认为通过测试，而应至少执行五次以上，以确保流量分别进入两个系统。

#### 我们的幸运

- 签发证书数量较少，未对大量订户产生影响
- 在2024年4月的时候我们旧的CA系统不再运行所有的流量都切换到了新的CA系统中，后续类似的情况将不再出现

### 行动项目

| 行动项目                             | 种类 | 到期日 |
| ------------------------------------ | ---- | ------ |
| 修复旧CA系统签发EV证书DN项不对的问题 |      |        |
